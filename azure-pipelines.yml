# -----------------------------------------------------------------
# azure-pipelines.yml
# Versión corregida de errores de sintaxis
# -----------------------------------------------------------------

trigger:
- main


variables:
- name: DOCKER_IMAGE_NAME # Variable normal
  value: 'samuelrodero/esi-media-g05-backend'
- group: 'RenderProjectSecrets'   # Grupo de variables
- group: 'DockerRegistrySecrets'  # Grupo de variables

stages:
# -----------------------------------------------------------------
# ETAPA 1: Compilar, Probar, Analizar y Publicar Imagen (CI)
# -----------------------------------------------------------------
- stage: Build
  displayName: 'Build, Test, Analyze & Push'
  jobs:
  - job: BuildJob
    displayName: 'CI & Docker Push (Windows Agent)'
    
    pool:
      name: 'Default' # Tu pool de agente auto-hospedado
      
    steps:
    # --- 1. Configurar Java 17 ---
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '17'
        jdkArchitecture: 'x64'
        jdkSourceOption: 'PreInstalled'
      displayName: 'Set up JDK 17'

    # --- 2. Compilar y Ejecutar Tests (para JaCoCo) ---
    - task: Maven@4
      inputs:
        mavenPomFile: 'esi_media/pom.xml' 
        goals: 'clean verify'
        options: '-Djava.awt.headless=true'
      displayName: 'Compile & Run Tests (mvnw.cmd verify)'
    # --- CORRECCIÓN 2: 'workingDirectory' movido fuera de 'inputs' ---
    

    # --- 3. Preparar Análisis de SonarQube ---
    - task: SonarQubePrepare@5
      inputs:
        SonarQube: 'Sonar ESI Connection' 
        scannerMode: 'Maven'
        projectKey: '2025-g05-backend'
        projectName: 'ESI Media Backend'
        extraProperties: |
          sonar.coverage.jacoco.xmlReportPaths=esi_media/target/site/jacoco/xml
      displayName: 'Prepare SonarQube Analysis'

    # --- 4. Ejecutar Análisis de SonarQube ---
    - task: Maven@4
      inputs:
        mavenPomFile: 'esi_media/pom.xml'
        goals: 'sonar:sonar'
      displayName: 'Run SonarQube Analysis'
    # --- CORRECCIÓN 3: 'workingDirectory' movido fuera de 'inputs' ---
    

    # --- 5. Publicar Resultados de SonarQube ---
    # ¡IMPORTANTE! Vuelto a añadir. Este paso espera el resultado del análisis.
    - task: SonarQubePublish@5
      inputs:
        pollingTimeoutSec: '300'
      displayName: 'Publish SonarQube Results'

    # --- 6. Iniciar sesión en Docker Hub ---
    - task: Docker@2
      inputs:
        containerRegistry: 'DockerHubConnection' 
        command: 'login'
      displayName: 'Login to Docker Hub'

    # --- 7. Construir la imagen de Docker (Linux) ---
    - task: Docker@2
      inputs:
        containerRegistry: 'DockerHubConnection'
        repository: $(DOCKER_IMAGE_NAME)
        command: 'build'
        dockerfile: 'esi_media/Dockerfile' 
        buildContext: '.' 
        tags: 'latest'
      displayName: 'Build Docker Image (Linux target)'

    # --- 8. Subir la imagen de Docker ---
    - task: Docker@2
      inputs:
        containerRegistry: 'DockerHubConnection'
        repository: $(DOCKER_IMAGE_NAME)
        command: 'push'
        tags: 'latest'
      displayName: 'Push Docker Image'

# -----------------------------------------------------------------
# ETAPA 2: Desplegar en Render (CD)
# -----------------------------------------------------------------
- stage: Deploy
  displayName: 'Deploy to Render'
  dependsOn: Build
  condition: succeeded()
  
  jobs:
  - job: DeployJob
    displayName: 'Trigger Render Deploy'
    pool:
      vmImage: 'windows-latest' 
      
    steps:
    - script: |
        curl -X POST "https://api.render.com/v1/services/$(RENDER_SERVICE_ID)/deploys" -H "Authorization: Bearer $(RENDER_API_KEY)" -H "Content-Type: application/json" -d "{\"image_path\": \"docker.io/$(DOCKER_IMAGE_NAME):latest\"}"
      displayName: 'Trigger Render API Deploy'